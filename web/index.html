<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VisualRiskAssessor - HSE Risk Assessment</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <style>
    :root { --p:#ff6d00; --s:#1565c0; --ok:#4caf50; --mid:#ffc107; --hi:#f44336; --x:#b71c1c; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:Segoe UI,Roboto,Arial,sans-serif; background:#f5f5f5; color:#212121; }
    .header { background:linear-gradient(120deg,#ff6d00,#e65100); color:#fff; text-align:center; padding:20px 12px; }
    .container { max-width:980px; margin:0 auto; padding:16px; }
    .card { background:#fff; border-radius:14px; padding:18px; margin-bottom:16px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .btn { border:none; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; }
    .btn + .btn { margin-left:8px; }
    .btn-primary { background:var(--p); color:#fff; }
    .btn-secondary { background:var(--s); color:#fff; }
    .btn-outline { background:#fff; color:var(--s); border:2px solid var(--s); }
    .hidden { display:none !important; }
    #uploadArea { border:2px dashed var(--s); border-radius:10px; padding:20px; margin-top:12px; background:#eef6ff; cursor:pointer; }
    #uploadArea:focus-visible { outline:3px solid #000; }
    #cameraSection { text-align:center; margin-top:12px; }
    #videoPreview,#resultImg { width:100%; max-width:620px; border-radius:10px; background:#000; }
    .warning { background:#fff3cd; color:#694f00; border-radius:8px; padding:10px; margin-bottom:10px; }
    .result-chip { display:inline-block; padding:6px 10px; border-radius:999px; color:#fff; font-weight:700; }
    .hazard-item { border-left:5px solid var(--mid); background:#fafafa; padding:10px; border-radius:8px; margin-bottom:8px; }
    .risk-low { border-left-color:var(--ok); }
    .risk-medium { border-left-color:var(--mid); }
    .risk-high { border-left-color:var(--hi); }
    .risk-extreme { border-left-color:var(--x); }
    .matrix { display:grid; grid-template-columns:42px repeat(5,1fr); gap:3px; max-width:450px; }
    .cell { min-height:36px; border-radius:5px; display:flex; align-items:center; justify-content:center; font-size:.8rem; font-weight:600; }
    .head { background:#1565c0; color:#fff; }
    .low { background:var(--ok); color:#fff; }
    .med { background:var(--mid); }
    .high { background:var(--hi); color:#fff; }
    .ext { background:var(--x); color:#fff; }
    .mark { outline:3px solid #000; }
    #loading { position:fixed; inset:0; background:rgba(0,0,0,.72); color:#fff; display:none; place-items:center; font-size:1.1rem; z-index:999; }
    #loading.active { display:grid; }
  </style>
</head>
<body>
  <header class="header">
    <h1 style="margin:0">VisualRiskAssessor</h1>
    <p style="margin:8px 0 0">GitHub Pages HSE visual risk tool</p>
  </header>

  <main class="container">
    <div id="envWarning" class="warning hidden" role="alert"></div>

    <section id="inputSec" class="card">
      <h2 style="margin-top:0">Image Input</h2>
      <button class="btn btn-primary" id="btnCamera">ðŸ“· Open Camera</button>
      <button class="btn btn-secondary" id="btnUpload">ðŸ–¼ Upload Image</button>
      <input id="fileInput" type="file" accept="image/*" class="hidden" />
      <div id="uploadArea" tabindex="0" role="button" aria-label="Upload an image">Click or press Enter/Space to upload an image.</div>

      <div id="cameraSection" class="hidden">
        <video id="videoPreview" autoplay playsinline></video><br/><br/>
        <button class="btn btn-primary" id="btnCapture">Capture</button>
        <button class="btn btn-outline" id="btnStop">Stop Camera</button>
      </div>
    </section>

    <section id="results" class="card hidden" aria-live="polite">
      <h2 style="margin-top:0">Assessment Results</h2>
      <div id="fallbackWarning" class="warning hidden">Fallback hazard estimation used due to model/runtime limitations.</div>
      <img id="resultImg" alt="Analyzed image" />
      <p><strong>Overall Risk Score:</strong> <span id="overallScore">0</span></p>
      <p><strong>Risk Level:</strong> <span id="overallLevel" class="result-chip">Assessing...</span></p>

      <h3>Hazards</h3>
      <div id="hazardsList"></div>

      <h3>Risk Matrix</h3>
      <div id="riskMatrix" class="matrix"></div>

      <h3>Recommendations</h3>
      <div id="recsList"></div>

      <button class="btn btn-secondary" id="btnExport">Export Report</button>
      <button class="btn btn-outline" id="btnReset">New Assessment</button>
    </section>
  </main>

  <div id="loading" aria-live="assertive">Analyzing image...</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const els = {
    envWarning: $('envWarning'), inputSec: $('inputSec'), results: $('results'), fileInput: $('fileInput'),
    uploadArea: $('uploadArea'), cameraSection: $('cameraSection'), videoPreview: $('videoPreview'), resultImg: $('resultImg'),
    overallScore: $('overallScore'), overallLevel: $('overallLevel'), hazardsList: $('hazardsList'), riskMatrix: $('riskMatrix'),
    recsList: $('recsList'), fallbackWarning: $('fallbackWarning'), loading: $('loading'),
    btnCamera: $('btnCamera'), btnUpload: $('btnUpload'), btnCapture: $('btnCapture'), btnStop: $('btnStop'),
    btnExport: $('btnExport'), btnReset: $('btnReset')
  };

  let model = null, stream = null, imageData = null, hazards = [], overall = 0, usedFallback = false;

  const hazardDB = {
    electrical:{name:'Electrical Hazard',L:4,S:4,kw:['wire','cable','electric','plug'],recs:['Isolate exposed circuits','Use insulated PPE']},
    slip:{name:'Slip/Trip/Fall Hazard',L:4,S:3,kw:['floor','ground','wet','slippery'],recs:['Dry floor immediately','Use anti-slip signage']},
    machinery:{name:'Machinery Hazard',L:3,S:4,kw:['machine','equipment','tool','motor'],recs:['Install guarding','Apply lockout-tagout']},
    fire:{name:'Fire Hazard',L:3,S:5,kw:['fire','flame','gas','smoke'],recs:['Remove ignition sources','Keep extinguisher nearby']},
    general:{name:'General Workplace Hazard',L:2,S:3,kw:[],recs:['Run manual inspection','Repeat assessment with clearer image']}
  };

  function showWarning(msg){ els.envWarning.textContent = msg; els.envWarning.classList.remove('hidden'); }
  function setLoading(v){ els.loading.classList.toggle('active', v); }
  function riskFor(score){ if(score<=5) return {label:'Low Risk', cls:'risk-low', color:'var(--ok)'}; if(score<=14) return {label:'Medium Risk', cls:'risk-medium', color:'var(--mid)'}; if(score<=19) return {label:'High Risk', cls:'risk-high', color:'var(--hi)'}; return {label:'Extreme Risk', cls:'risk-extreme', color:'var(--x)'}; }

  async function initModel(){
    if (location.protocol === 'http:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      showWarning('Use HTTPS on GitHub Pages for camera access. Upload still works.');
    }
    try { model = await mobilenet.load(); }
    catch { showWarning('ML model failed to load. App will use fallback hazard estimation.'); }
  }

  async function startCamera(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      els.videoPreview.srcObject = stream;
      els.cameraSection.classList.remove('hidden');
    } catch { showWarning('Camera unavailable. Use upload instead.'); }
  }

  function stopCamera(){ if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; } els.cameraSection.classList.add('hidden'); }
  function openFilePicker(){ els.fileInput.click(); }

  function fallback(){ usedFallback = true; const h = hazardDB.general; hazards = [{name:h.name,L:h.L,S:h.S,risk:h.L*h.S,conf:0.5,recs:h.recs}]; }

  function mapPredictions(preds){
    const found = new Set(); hazards = [];
    preds.forEach(p => {
      const name = p.className.toLowerCase();
      Object.entries(hazardDB).forEach(([key,h]) => {
        h.kw.forEach(kw => {
          if(name.includes(kw) && !found.has(key)){
            found.add(key);
            hazards.push({name:h.name,L:h.L,S:h.S,risk:h.L*h.S,conf:p.probability,recs:h.recs});
          }
        });
      });
    });
    if(!hazards.length) fallback();
  }

  function render(){
    els.results.classList.remove('hidden');
    els.resultImg.src = imageData;
    els.fallbackWarning.classList.toggle('hidden', !usedFallback);

    overall = hazards.length ? Math.max(...hazards.map(h => h.risk)) : 0;
    const r = riskFor(overall);
    els.overallScore.textContent = String(overall);
    els.overallLevel.textContent = r.label;
    els.overallLevel.style.background = r.color;

    els.hazardsList.textContent = '';
    hazards.forEach(h => {
      const hr = riskFor(h.risk);
      const item = document.createElement('div');
      item.className = `hazard-item ${hr.cls}`;
      const t = document.createElement('div');
      t.textContent = `${h.name} (${Math.round((h.conf||0)*100)}%)`;
      const d = document.createElement('div');
      d.textContent = `Likelihood ${h.L}, Severity ${h.S}, Risk ${h.risk} (${hr.label.replace(' Risk','')})`;
      item.append(t,d); els.hazardsList.appendChild(item);
    });

    els.riskMatrix.textContent = '';
    const add = (txt, cls) => { const c = document.createElement('div'); c.className = `cell ${cls}`; c.textContent = txt; els.riskMatrix.appendChild(c); };
    add('', ''); [1,2,3,4,5].forEach(s => add(`S${s}`, 'head'));
    for(let l=1;l<=5;l++){
      add(`L${l}`, 'head');
      for(let s=1;s<=5;s++){
        const score=l*s; const c=document.createElement('div');
        let cls='low'; if(score>=20)cls='ext'; else if(score>=15)cls='high'; else if(score>=6)cls='med';
        c.className=`cell ${cls}${hazards.some(h=>h.risk===score)?' mark':''}`; c.textContent=String(score); els.riskMatrix.appendChild(c);
      }
    }

    els.recsList.textContent = '';
    [...new Set(hazards.flatMap(h => h.recs || []))].forEach(rec => { const p = document.createElement('p'); p.textContent = `â€¢ ${rec}`; els.recsList.appendChild(p); });
  }

  async function analyze(dataUrl){
    setLoading(true); usedFallback = false;
    try {
      if(model){
        const img = new Image();
        await new Promise((resolve,reject) => { img.onload = resolve; img.onerror = reject; img.src = dataUrl; });
        const preds = await model.classify(img);
        mapPredictions(preds);
      } else {
        fallback();
      }
    } catch {
      fallback();
    } finally {
      imageData = dataUrl;
      render();
      setLoading(false);
    }
  }

  function exportReport(){
    const risk = riskFor(overall).label;
    let out = `HSE Risk Assessment\nDate: ${new Date().toISOString()}\nRisk: ${risk} (${overall}/25)\nFallback Used: ${usedFallback?'YES':'NO'}\n\nHazards:\n`;
    hazards.forEach((h,i)=> out += `${i+1}. ${h.name} | L=${h.L} S=${h.S} Risk=${h.risk}\n`);
    out += `\nRecommendations:\n${[...new Set(hazards.flatMap(h=>h.recs||[]))].map((r,i)=>`${i+1}. ${r}`).join('\n')}`;
    const blob = new Blob([out], {type:'text/plain'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `HSE_Risk_Assessment_${new Date().toISOString().slice(0,10)}.txt`; a.click(); URL.revokeObjectURL(url);
  }

  function resetApp(){ stopCamera(); hazards=[]; overall=0; imageData=null; usedFallback=false; els.fileInput.value=''; els.results.classList.add('hidden'); }
  function captureFromCamera(){ const v=els.videoPreview; const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); stopCamera(); analyze(c.toDataURL('image/jpeg',0.9)); }

  els.btnCamera.addEventListener('click', startCamera);
  els.btnUpload.addEventListener('click', openFilePicker);
  els.btnCapture.addEventListener('click', captureFromCamera);
  els.btnStop.addEventListener('click', stopCamera);
  els.btnExport.addEventListener('click', exportReport);
  els.btnReset.addEventListener('click', resetApp);
  els.fileInput.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.type.startsWith('image/')) { showWarning('Please upload a valid image file.'); e.target.value=''; return; }
    const reader = new FileReader();
    reader.onload = (ev) => analyze(ev.target.result);
    reader.onerror = () => showWarning('Failed to read selected image.');
    reader.readAsDataURL(f);
  });
  els.uploadArea.addEventListener('click', openFilePicker);
  els.uploadArea.addEventListener('keydown', (e) => { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openFilePicker(); }});

  window.openFilePicker = openFilePicker;
  window.startCam = startCamera;
  window.stopCam = stopCamera;
  window.capture = captureFromCamera;
  window.analyze = analyze;
  window.exportReport = exportReport;
  window.resetApp = resetApp;

  initModel();
})();
</script>
</body>
</html>
