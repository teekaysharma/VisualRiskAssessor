<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisualRiskAssessor - HSE Risk Assessment</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
    <style>
        :root { --primary: #FF6D00; --primary-dark: #E65100; --secondary: #1565C0; --bg: #F5F5F5; --surface: #fff; --text: #212121; --text2: #616161; --low: #4CAF50; --med: #FFC107; --high: #F44336; --extreme: #B71C1C; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 8px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .card { background: var(--surface); border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .card h2 { color: var(--secondary); margin-bottom: 20px; font-size: 1.4rem; }
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 25px 0; }
        .btn { padding: 16px 32px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #0D47A1; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        .camera-sec { display: none; text-align: center; }
        .camera-sec.active { display: block; }
        #videoPreview { width: 100%; max-width: 600px; border-radius: 12px; background: #000; }
        .upload-area { border: 3px dashed var(--secondary); border-radius: 16px; padding: 50px; text-align: center; cursor: pointer; transition: 0.3s; background: #f8fbff; }
        .upload-area:hover { background: #e3f2fd; border-color: var(--primary); }
        .upload-icon { font-size: 4rem; }
        #fileInput { display: none; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 70px; height: 70px; border: 5px solid rgba(255,255,255,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 25px; font-size: 1.3rem; }
        .results { display: none; }
        .results.active { display: block; }
        .photo-ref { text-align: center; margin-bottom: 25px; }
        .photo-ref img { max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .photo-label { display: inline-block; background: var(--secondary); color: white; padding: 8px 20px; border-radius: 20px; margin-top: 15px; font-weight: 600; }
        .overall-risk { text-align: center; margin: 25px 0; padding: 30px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 16px; }
        .fallback-warning { display: none; margin: 15px 0 20px; padding: 16px; border-radius: 12px; border: 2px solid #f57c00; background: #fff3e0; color: #7a3e00; font-weight: 700; }
        .fallback-warning.active { display: block; }
        .overall-score { font-size: 4rem; font-weight: 800; }
        .overall-level { font-size: 1.8rem; font-weight: 700; margin-top: 10px; }
        .hazard-item { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--med); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .hazard-item.risk-low { border-left-color: var(--low); }
        .hazard-item.risk-medium { border-left-color: var(--med); }
        .hazard-item.risk-high { border-left-color: var(--high); }
        .hazard-item.risk-extreme { border-left-color: var(--extreme); }
        .hazard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .hazard-name { font-size: 1.2rem; font-weight: 700; }
        .hazard-conf { background: var(--secondary); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; }
        .hazard-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .detail-item { text-align: center; }
        .detail-label { font-size: 0.75rem; color: var(--text2); text-transform: uppercase; }
        .detail-value { font-size: 1.2rem; font-weight: 700; }
        .matrix-sec { padding: 25px; background: linear-gradient(135deg, #f8f9fa, #fff); border-radius: 16px; margin: 25px 0; }
        .matrix-title { text-align: center; color: var(--secondary); margin-bottom: 20px; font-size: 1.4rem; }
        .risk-matrix { display: grid; grid-template-columns: 40px repeat(5, 1fr); gap: 3px; max-width: 480px; margin: 0 auto; }
        .matrix-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border-radius: 6px; min-height: 50px; }
        .matrix-label { background: transparent; font-weight: 700; color: var(--text2); font-size: 0.65rem; }
        .matrix-header { background: var(--secondary); color: white; font-weight: 700; }
        .cell-low { background: var(--low); color: white; }
        .cell-medium { background: var(--med); color: #000; }
        .cell-high { background: var(--high); color: white; }
        .cell-extreme { background: var(--extreme); color: white; }
        .current-marker { border: 4px solid gold !important; box-shadow: 0 0 15px gold; }
        .methodology { background: #E3F2FD; padding: 20px; border-radius: 12px; margin: 20px 0; font-size: 0.95rem; color: #0D47A1; }
        .methodology h4 { color: var(--secondary); margin-bottom: 10px; }
        .rec-item { display: flex; gap: 15px; padding: 18px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
        .rec-icon { font-size: 1.8rem; flex-shrink: 0; }
        .rec-content h4 { color: var(--text); margin-bottom: 5px; }
        .rec-content p { color: var(--text2); font-size: 0.95rem; }
        .actions { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-restart { background: #616161; color: white; }
        .hidden { display: none !important; }
        .instr { text-align: center; color: var(--text2); margin: 15px 0; font-size: 1.05rem; }
        @media (max-width: 768px) { .btn { width: 100%; justify-content: center; } .hazard-details { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <h1>üî¨ VisualRiskAssessor</h1>
        <p>HSE Risk Assessment - Identify Hazards, Assess Risks, Ensure Safety</p>
    </header>
    <main class="container">
        <section class="card" id="inputSec">
            <h2>üì∏ Capture Workplace Image</h2>
            <p class="instr">Take a photo or upload an image of a workplace area to analyze for potential health and safety hazards.</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startCam()">üì∑ Take Photo</button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üñºÔ∏è Upload from Library</button>
                <button class="btn btn-outline hidden" onclick="stopCam()" id="stopBtn">‚èπÔ∏è Stop Camera</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
            <div class="camera-sec" id="camSec"><video id="videoPreview" autoplay playsinline muted webkit-playsinline style="width:100%;height:auto;max-height:70vh;object-fit:cover;border-radius:12px;background:#000;"></video><button class="btn btn-primary" style="margin:15px auto" onclick="capture()">üî¥ Capture</button></div>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()"><div class="upload-icon">üìÅ</div><div class="instr">Click to upload or drag image<br><small>JPEG, PNG, WEBP</small></div></div>
        </section>
        <div class="loading" id="loading"><div class="spinner"></div><div class="loading-text" id="loadText">Analyzing image...</div></div>
        <section class="results" id="results">
            <div class="card photo-ref"><img id="resultImg"><div class="photo-label">üì∏ Reference Image</div></div>
            <div class="fallback-warning" id="fallbackWarning">‚ö†Ô∏è Estimated hazards only: automatic analysis failed and placeholder hazards are being shown. Verify conditions manually before acting on this report.</div>
            <div class="overall-risk"><div>OVERALL RISK SCORE</div><div class="overall-score" id="overallScore">0</div><div class="overall-level" id="overallLevel">Assessing...</div></div>
            <div class="card"><h2>üö® Hazards Identified</h2><p class="instr">The following hazards were detected:</p><div id="hazardsList"></div></div>
            <div class="card"><h2>üìä Risk Assessment Matrix</h2><div class="matrix-sec"><div class="matrix-title">Likelihood √ó Severity = Risk</div><div class="risk-matrix" id="riskMatrix"></div></div><div class="methodology"><h4>üìñ HSE Methodology</h4><p><strong>Risk = Likelihood √ó Severity</strong></p><p>üü¢ Low (1-5) - Acceptable | üü° Medium (6-14) - Additional controls | üî¥ High (15-19) - Urgent action | ‚ö´ Extreme (20-25) - Immediate action</p></div></div>
            <div class="card"><h2>üõ°Ô∏è Safety Recommendations</h2><div id="recsList"></div></div>
            <div class="actions"><button class="btn btn-primary" onclick="exportReport()">üì• Download Full Report</button><button class="btn btn-restart" onclick="resetApp()">üîÑ New Assessment</button></div>
        </section>
    </main>
    <script>
    const hazardDB = {
        slip_floor:{name:"Floor Surface Hazard",kw:["floor","ground","tile","carpet"],L:4,S:3,recs:[{i:"üßπ",t:"Clean Floors",d:"Keep floors clean and free from debris"},{i:"‚ö†Ô∏è",t:"Warning Signs",d:"Use wet floor signs"},{i:"üëü",t:"Footwear",d:"Slip-resistant safety footwear"}]},
        slip_stairs:{name:"Stairway Hazard",kw:["stairs","staircase","step","ladder"],L:3,S:4,recs:[{i:"ü™ú",t:"Handrails",d:"Install secure handrails"},{i:"‚ö†Ô∏è",t:"Anti-slip",d:"Apply anti-slip strips"},{i:"üî¶",t:"Lighting",d:"Adequate stair lighting"}]},
        slip_water:{name:"Wet Surface Hazard",kw:["water","liquid","puddle","spill"],L:4,S:3,recs:[{i:"üßΩ",t:"Immediate Cleanup",d:"Clean spills immediately"},{i:"üõë",t:"Isolation",d:"Block off wet areas"},{i:"üíß",t:"Source",d:"Fix source of water"}]},
        elec_outlet:{name:"Electrical Outlet",kw:["outlet","socket","power"],L:2,S:5,recs:[{i:"üîå",t:"Inspect",d:"Regular outlet inspection"},{i:"üö´",t:"No Overload",d:"Don't overload outlets"},{i:"‚ö°",t:"GFCI",d:"Install GFCI protection"}]},
        elec_wire:{name:"Exposed Wiring",kw:["wire","cable","cord"],L:3,S:5,recs:[{i:"üîß",t:"Cover Wires",d:"Cover exposed wiring"},{i:"üõ°Ô∏è",t:"Conduit",d:"Use cable conduit"},{i:"‚ö°",t:"Power Off",d:"Turn off power before work"}]},
        fire_ext:{name:"Fire Equipment",kw:["extinguisher","fire alarm"],L:2,S:5,recs:[{i:"‚úÖ",t:"Accessible",d:"Keep extinguishers accessible"},{i:"üìÖ",t:"Inspect",d:"Monthly inspections"},{i:"üè∑Ô∏è",t:"Signage",d:"Clear emergency signage"}]},
        fire_flam:{name:"Flammable Materials",kw:["flammable","gasoline","chemical"],L:2,S:5,recs:[{i:"üè™",t:"Storage",d:"Approved safety cabinets"},{i:"üö≠",t:"No Smoking",d:"Strict no smoking policy"},{i:"üßØ",t:"Suppression",d:"Fire suppression nearby"}]},
        chem:{name:"Chemical Storage",kw:["bottle","container","drum","can"],L:2,S:4,recs:[{i:"üß™",t:"Labeling",d:"Clear chemical labeling"},{i:"üóÑÔ∏è",t:"Storage",d:"Approved chemical cabinets"},{i:"üò∑",t:"PPE",d:"Appropriate PPE available"}]},
        machine:{name:"Machinery Hazard",kw:["machine","motor","equipment","tool"],L:3,S:4,recs:[{i:"üõ°Ô∏è",t:"Guards",d:"Safety guards in place"},{i:"üîí",t:"Lockout",d:"Lockout/tagout procedures"},{i:"üë∑",t:"Training",d:"Operator certification"}]},
        ergo:{name:"Workstation Ergonomics",kw:["chair","desk","computer","keyboard"],L:4,S:2,recs:[{i:"ü™ë",t:"Ergonomic Chair",d:"Adjustable seating"},{i:"üñ•Ô∏è",t:"Monitor Position",d:"Eye level monitor"},{i:"‚è∞",t:"Breaks",d:"Regular break schedule"}]},
        ergo_lift:{name:"Manual Handling",kw:["box","heavy","lift"],L:4,S:3,recs:[{i:"üèãÔ∏è",t:"Lifting Aids",d:"Use mechanical aids"},{i:"üë•",t:"Team Lift",d:"Two-person for heavy loads"},{i:"üìê",t:"Technique",d:"Proper lifting training"}]},
        height:{name:"Working at Height",kw:["ladder","scaffold","building","construction"],L:2,S:5,recs:[{i:"ü¶∫",t:"Fall Protection",d:"Use fall protection"},{i:"üèóÔ∏è",t:"Scaffold",d:"Proper scaffold inspection"},{i:"‚úÖ",t:"Daily Checks",d:"Documented daily inspections"}]},
        general:{name:"General Workplace",kw:["office","room","indoor","workspace"],L:3,S:2,recs:[{i:"üßπ",t:"Housekeeping",d:"Clean organized areas"},{i:"ü™ú",t:"Clear Walkways",d:"No obstructions"},{i:"üî¶",t:"Emergency Lighting",d:"Functional lighting"}]}
    };
    let model=null,video=null,imgData=null,hazards=[],overallScore=0,analysisUsedFallback=false;
    async function init(){
        try{
            model=await mobilenet.load();
            console.log('Model loaded');
        }catch(e){
            console.error('Model failed', e);
        }
    }
    try { model = await mobilenet.load(); }
    catch { usedFallback = true; showWarning('ML model failed to load. Using heuristic analysis.'); }
  }

  async function refreshCameraOptions() {
    if (!navigator.mediaDevices?.enumerateDevices || !els.cameraSelect) return;
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter((d) => d.kind === 'videoinput');
      const current = els.cameraSelect.value;
      els.cameraSelect.textContent = '';
      const auto = document.createElement('option');
      auto.value = '';
      auto.textContent = 'Auto camera';
      els.cameraSelect.appendChild(auto);
      cams.forEach((cam, idx) => {
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `Camera ${idx + 1}`;
        els.cameraSelect.appendChild(opt);
      });
      els.cameraSelect.value = cams.some(c => c.deviceId === current) ? current : '';
      selectedDeviceId = els.cameraSelect.value;
    } catch (_) {}
  }

  async function waitForVideoFrame(video, timeoutMs = 3000) {
    const start = Date.now();
    return new Promise((resolve) => {
      function check() {
        if (video.videoWidth > 0 && video.videoHeight > 0) {
          resolve(true);
          return;
        }
        if (Date.now() - start >= timeoutMs) {
          resolve(false);
          return;
        }
        requestAnimationFrame(check);
      }
      check();
    });
  }

  async function startCamera(){
    stopCamera();

    const legacyGetUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    if (!navigator.mediaDevices?.getUserMedia && !legacyGetUserMedia) {
      showWarning('Camera API is not available in this browser. Please use Upload Image.');
      return;
    }

        try {
            // Try with rear camera first
            let stream = await navigator.mediaDevices.getUserMedia(constraints);

            // If rear camera fails, try front camera
            if (!stream.getVideoTracks().length) {
                stream.getTracks().forEach(track => track.stop());
                constraints.video.facingMode = "user";
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            }

            const videoEl = document.getElementById("videoPreview");
            videoEl.srcObject = stream;
            video = stream;
            
            // Wait for video to load
            videoEl.onloadedmetadata = () => {
                videoEl.play();
                document.getElementById("camSec").classList.add("active");
                document.getElementById("uploadArea").classList.add("hidden");
                document.getElementById("stopBtn").classList.remove("hidden");
            };
            
        } catch (error) {
            console.error("Camera error:", error);
            
            let errorMessage = "Unable to access camera. ";
            
            if (error.name === "NotAllowedError") {
                errorMessage += "Please allow camera permission and try again.";
            } else if (error.name === "NotFoundError") {
                errorMessage += "No camera found on this device.";
            } else if (error.name === "NotReadableError") {
                errorMessage += "Camera is being used by another application.";
            } else {
                errorMessage += "Please use the upload feature instead.";
            }
            
            // Show more detailed error and suggest upload
            const shouldUpload = confirm(errorMessage + "\n\nWould you like to upload an image instead?");
            if (shouldUpload) {
                document.getElementById("fileInput").click();
            }
        }
    }
    function stopCam(){if(video){video.getTracks().forEach(t=>t.stop());video=null;}document.getElementById('camSec').classList.remove('active');document.getElementById('uploadArea').classList.remove('hidden');document.getElementById('stopBtn').classList.add('hidden');}
    function resetApp(){
        stopCam();
        hazards=[];
        overallScore=0;
        analysisUsedFallback=false;
        imgData=null;
        document.getElementById('fileInput').value='';
        document.getElementById('hazardsList').innerHTML='';
        document.getElementById('recsList').innerHTML='';
        document.getElementById('riskMatrix').innerHTML='';
        document.getElementById('overallScore').textContent='0';
        document.getElementById('overallLevel').textContent='Assessing...';
        document.getElementById('overallLevel').style.background='';
        document.getElementById('fallbackWarning').classList.remove('active');
        document.getElementById('resultImg').removeAttribute('src');
        document.getElementById('results').classList.remove('active');
        document.getElementById('inputSec').classList.remove('hidden');
        window.scrollTo({top:0,behavior:'smooth'});
    }
    try { model = await mobilenet.load(); }
    catch { usedFallback = true; showWarning('ML model failed to load. Using heuristic analysis.'); }
  }

  async function refreshCameraOptions() {
    if (!navigator.mediaDevices?.enumerateDevices || !els.cameraSelect) return;
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter((d) => d.kind === 'videoinput');
      const current = els.cameraSelect.value;
      els.cameraSelect.textContent = '';
      const auto = document.createElement('option');
      auto.value = '';
      auto.textContent = 'Auto camera';
      els.cameraSelect.appendChild(auto);
      cams.forEach((cam, idx) => {
        const opt = document.createElement('option');
        opt.value = cam.deviceId;
        opt.textContent = cam.label || `Camera ${idx + 1}`;
        els.cameraSelect.appendChild(opt);
      });
      els.cameraSelect.value = cams.some(c => c.deviceId === current) ? current : '';
      selectedDeviceId = els.cameraSelect.value;
    } catch (_) {}
  }

  async function waitForVideoFrame(video, timeoutMs = 3000) {
    const start = Date.now();
    return new Promise((resolve) => {
      function check() {
        if (video.videoWidth > 0 && video.videoHeight > 0) {
          resolve(true);
          return;
        }
        if (Date.now() - start >= timeoutMs) {
          resolve(false);
          return;
        }
        requestAnimationFrame(check);
      }
      check();
    });
  }

  async function startCamera(){
    stopCamera();

    const legacyGetUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    if (!navigator.mediaDevices?.getUserMedia && !legacyGetUserMedia) {
      showWarning('Camera API is not available in this browser. Please use Upload Image.');
      return;
    }
    async function analyze(img){showLoad();hazards=[];analysisUsedFallback=false;try{if(model&&img){const i=new Image();i.onload=async()=>{try{const p=await model.classify(i);mapHazards(p);calcOverall();display();}catch(e){fallback();}hideLoad();};i.onerror=()=>{fallback();hideLoad();};i.src=img;}else{setTimeout(()=>{fallback();hideLoad();},1500);}}catch(e){fallback();hideLoad();}}
    function mapHazards(preds){const found=new Set();preds.forEach(p=>{const l=p.className.toLowerCase();Object.entries(hazardDB).forEach(([k,h])=>{h.kw.forEach(kw=>{if(l.includes(kw)&&!found.has(k)){found.add(k);hazards.push({id:k,...h,conf:p.probability,risk:h.L*h.S});}});});});if(hazards.length===0)hazards.push({...hazardDB.general,conf:0.8,risk:6});}
    function fallback(){analysisUsedFallback=true;hazards=[{...hazardDB.general,conf:0.8,risk:6},{...hazardDB.slip_floor,conf:0.6,risk:12}];calcOverall();display();}
    function calcOverall(){overallScore=hazards.length?Math.max(...hazards.map(h=>h.risk)):0;}
    function getRisk(s){if(s<=5)return{l:'Low',c:'#4CAF50'};if(s<=14)return{l:'Medium',c:'#FFC107'};if(s<=19)return{l:'High',c:'#F44336'};return{l:'Extreme',c:'#B71C1C'};}
    function display(){document.getElementById('resultImg').src=imgData;document.getElementById('fallbackWarning').classList.toggle('active',analysisUsedFallback);const r=getRisk(overallScore);document.getElementById('overallScore').textContent=overallScore;document.getElementById('overallLevel').textContent=r.l+' Risk';document.getElementById('overallLevel').style.background=r.c;const L=['Rare','Unlikely','Possible','Likely','Certain'],S=['','Insignificant','Minor','Moderate','Major','Catastrophic'];document.getElementById('hazardsList').innerHTML=hazards.map(h=>{const r=getRisk(h.risk);return`<div class="hazard-item risk-${r.l.toLowerCase()}"><div class="hazard-header"><span class="hazard-name">${h.name}</span><span class="hazard-conf">${Math.round(h.conf*100)}%</span></div><div class="hazard-details"><div class="detail-item"><div class="detail-label">Likelihood</div><div class="detail-value">${h.L}-${L[h.L-1]}</div></div><div class="detail-item"><div class="detail-label">Severity</div><div class="detail-value">${h.S}-${S[h.S]}</div></div><div class="detail-item"><div class="detail-label">Risk</div><div class="detail-value" style="color:${r.c}">${h.risk}</div></div><div class="detail-item"><div class="detail-label">Level</div><div class="detail-value" style="color:${r.c}">${r.l}</div></div></div></div>`;}).join('');drawMatrix();dispRecs();document.getElementById('results').classList.add('active');document.getElementById('inputSec').classList.add('hidden');window.scrollTo({top:0,behavior:'smooth'});}
    function drawMatrix(){const m=document.getElementById('riskMatrix');let html='<div class="matrix-cell"></div>';['1','2','3','4','5'].forEach(s=>html+=`<div class="matrix-cell matrix-header">S:${s}</div>`);for(let l=0;l<5;l++){html+=`<div class="matrix-cell matrix-header">L:${l+1}</div>`;for(let s=0;s<5;s++){const sc=(l+1)*(s+1),cls=sc>=20?'cell-extreme':sc>=15?'cell-high':sc>=6?'cell-medium':'cell-low',mk=hazards.some(h=>h.risk===sc)?'current-marker':'';html+=`<div class="matrix-cell ${cls} ${mk}">${sc}</div>`;}}m.innerHTML=html;}
    function dispRecs(){const recs=[];hazards.forEach(h=>{if(h.recs)h.recs.forEach(r=>{if(!recs.find(x=>x.t===r.t))recs.push(r);});});recs.push({i:"üìã",t:"Regular Audits",d:"Conduct routine safety inspections"},{i:"üì¢",t:"Report Hazards",d:"Encourage immediate hazard reporting"});document.getElementById('recsList').innerHTML=recs.map(r=>`<div class="rec-item"><div class="rec-icon">${r.i}</div><div class="rec-content"><h4>${r.t}</h4><p>${r.d}</p></div></div>`).join('');}
    function exportReport(){
        const L=['Rare','Unlikely','Possible','Likely','Certain'];
        const S=[ '','Insignificant','Minor','Moderate','Major','Catastrophic'];
        const now=new Date();
        const r=getRisk(overallScore);
        let rep=`

                    OCCUPATIONAL HEALTH & SAFETY RISK ASSESSMENT
                              ISO 45001:2018 COMPLIANT


DOCUMENT REFERENCE:    HSE-RA-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${(now.getDate()).toString().padStart(2,'0')}-${Date.now().toString().slice(-6)}
ASSESSMENT DATE:     ${now.toLocaleDateString()}
ASSESSMENT TIME:     ${now.toLocaleTimeString()}
METHODOLOGY:         ISO 45001:2018 / ISO 31000:2018


                          ASSESSMENT SUMMARY


OVERALL RISK RATING:     ${r.l.toUpperCase()}
RISK SCORE:             ${overallScore} / 25
HAZARDS IDENTIFIED:     ${hazards.length}

${analysisUsedFallback ? `ANALYSIS NOTICE:
  Hazard entries are ESTIMATED PLACEHOLDERS because automated
  image analysis failed. Manual verification is required.
` : ''}


RISK MATRIX

        Severity  1    2    3    4    5
Likelihood
    1         1    2    3    4    5   Rare
    2         2    4    6    8   10   Unlikely
    3         3    6    9   12   15   Possible
    4         4    8   12   16   20   Likely
    5         5   10   15   20   25   Certain


                          HAZARDS IDENTIFIED

`;
        hazards.forEach((h,i)=>{
            const risk=getRisk(h.risk);
            rep+=`
--------------------------------------------------------------------------------
HAZARD #${i+1}: ${h.name.toUpperCase()}
--------------------------------------------------------------------------------
CATEGORY:              ${h.category || 'Workplace Hazard'}
CONFIDENCE:           ${Math.round(h.conf*100)}%

RISK ANALYSIS:
  Likelihood:       ${h.L} - ${L[h.L-1]}
  Severity:         ${h.S} - ${S[h.S]}
  Risk Score:       ${h.risk}
  Risk Level:       ${risk.l.toUpperCase()}

CONTROLS REQUIRED:
`;
            if(h.recs){h.recs.forEach((rec,idx)=>{rep+=`  ${idx+1}. ${rec.t} - ${rec.d}`;});}
            rep+="\\n";
        });
        rep+=`


                          RISK CLASSIFICATION


 EXTREME (20-25): Immediate action - STOP WORK until controlled

    setCameraStatus('Opening camera...');

    const attempts = [
      { video: true, audio: false },
      { video: { facingMode: 'environment' }, audio: false },
      { video: { facingMode: { ideal: 'environment' } }, audio: false },
      { video: { facingMode: { ideal: 'user' } }, audio: false }
    ];

    async function getStream(constraints) {
      if (navigator.mediaDevices?.getUserMedia) {
        return navigator.mediaDevices.getUserMedia(constraints);
      }
      return new Promise((resolve, reject) => legacyGetUserMedia.call(navigator, constraints, resolve, reject));
    }

    for (const constraints of attempts) {
      try {
        stream = await getStream(constraints);
        els.videoPreview.srcObject = stream;
        els.videoPreview.muted = true;
        els.videoPreview.setAttribute('playsinline', 'true');
        els.cameraSection.classList.remove('hidden');

        await new Promise((resolve) => {
          const timer = setTimeout(resolve, 2500);
          els.videoPreview.onloadedmetadata = () => { clearTimeout(timer); resolve(); };
        });

        try { await els.videoPreview.play(); } catch (_) { }

        const hasFrame = await waitForVideoFrame(els.videoPreview, 4000);
        if (hasFrame) {
          setCameraStatus('Camera ready.');
          setTimeout(() => setCameraStatus(''), 1500);
          return;
        }

        // still keep stream open; some devices are slow to first frame
        setCameraStatus('Camera connected. Waiting for first frame...');
        return;
      } catch (_) {
      }
    }

    showWarning('Unable to start camera stream. Check browser permissions, close other camera apps, and try again.');
    setCameraStatus('');
    stopCamera();
  }

  function stopCamera(){
    setCameraStatus('');
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    if (els.videoPreview) { els.videoPreview.pause(); els.videoPreview.srcObject = null; }
    els.cameraSection.classList.add('hidden');
  }

  function openFilePicker(){ els.fileInput.click(); }

  function heuristicHazardsFromCanvas(canvas) {
    const ctx = canvas.getContext('2d');
    const { width, height } = canvas;
    const img = ctx.getImageData(0, 0, width, height).data;
    let sum = 0, edge = 0;
    for (let i = 0; i < img.length; i += 16) {
      const v = (img[i] + img[i+1] + img[i+2]) / 3;
      sum += v;
      if (i > 16) {
        const pv = (img[i-16] + img[i-15] + img[i-14]) / 3;
        if (Math.abs(v - pv) > 45) edge++;
      }
    }
    const samples = Math.floor(img.length / 16);
    const avg = sum / Math.max(samples, 1);
    const edgeRatio = edge / Math.max(samples, 1);

    const out = [];
    if (avg < 80) out.push({name:'Low Visibility Hazard',L:3,S:3,risk:9,conf:0.72,recs:['Improve workplace lighting','Use high-visibility safety markers']});
    if (edgeRatio > 0.2) out.push({name:'Clutter/Obstruction Hazard',L:3,S:2,risk:6,conf:0.69,recs:['Clear walk paths and floor obstructions','Apply 5S housekeeping checks']});
    if (out.length === 0) out.push({name:'General Workplace Hazard',L:2,S:2,risk:4,conf:0.65,recs:['Run manual inspection','Verify with site supervisor']});
    return out;
  }

  function mapPredictions(preds){
    const found = new Set();
    const out = [];
    preds.forEach(p => {
      const name = p.className.toLowerCase();
      Object.entries(hazardDB).forEach(([key,h]) => {
        h.kw.forEach(kw => {
          if(name.includes(kw) && !found.has(key)) {
            found.add(key);
            out.push({name:h.name,L:h.L,S:h.S,risk:h.L*h.S,conf:p.probability,recs:h.recs});
          }
        });
      });
    });
    return out;
  }

  function render(){
    els.results.classList.remove('hidden');
    els.resultImg.src = imageData;
    els.fallbackWarning.classList.toggle('hidden', !usedFallback);

    overall = hazards.length ? Math.max(...hazards.map(h => h.risk)) : 0;
    const r = riskFor(overall);
    els.overallScore.textContent = String(overall);
    els.overallLevel.textContent = r.label;
    els.overallLevel.style.background = r.color;

    els.hazardsList.textContent = '';
    hazards.forEach(h => {
      const hr = riskFor(h.risk);
      const item = document.createElement('div');
      item.className = `hazard-item ${hr.cls}`;
      const t = document.createElement('div');
      t.textContent = `${h.name} (${Math.round((h.conf||0)*100)}%)`;
      const d = document.createElement('div');
      d.textContent = `Likelihood ${h.L}, Severity ${h.S}, Risk ${h.risk} (${hr.label.replace(' Risk','')})`;
      item.append(t,d);
      els.hazardsList.appendChild(item);
    });

    els.riskMatrix.textContent = '';
    const add = (txt, cls) => { const c = document.createElement('div'); c.className = `cell ${cls}`; c.textContent = txt; els.riskMatrix.appendChild(c); };
    add('', ''); [1,2,3,4,5].forEach(s => add(`S${s}`, 'head'));
    for(let l=1;l<=5;l++){
      add(`L${l}`, 'head');
      for(let s=1;s<=5;s++){
        const score=l*s; const c=document.createElement('div');
        let cls='low'; if(score>=20)cls='ext'; else if(score>=15)cls='high'; else if(score>=6)cls='med';
        c.className=`cell ${cls}${hazards.some(h=>h.risk===score)?' mark':''}`;
        c.textContent=String(score);
        els.riskMatrix.appendChild(c);
      }
    }

    els.recsList.textContent = '';
    const recs = [...new Set(hazards.flatMap(h => h.recs || []))];
    recs.forEach(rec => { const p = document.createElement('p'); p.textContent = `‚Ä¢ ${rec}`; els.recsList.appendChild(p); });
  }

  async function analyze(dataUrl){
    setLoading(true);
    try {
      imageData = dataUrl;
      hazards = [];

      const img = new Image();
      await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; img.src = dataUrl; });
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext('2d').drawImage(img, 0, 0);

      if (model) {
        try {
          const preds = await model.classify(img);
          hazards = mapPredictions(preds);
        } catch {
          usedFallback = true;
        }
      }

      if (hazards.length === 0) {
        hazards = heuristicHazardsFromCanvas(canvas);
      }

      render();
    } catch {
      usedFallback = true;
      hazards = [{name:'General Workplace Hazard',L:2,S:2,risk:4,conf:0.5,recs:['Run manual inspection','Repeat assessment with clearer image']}];
      render();
    } finally {
      setLoading(false);
    }
  }

  function exportReport(){
    const risk = riskFor(overall).label;
    let out = `HSE Risk Assessment\nDate: ${new Date().toISOString()}\nRisk: ${risk} (${overall}/25)\nHeuristic Mode: ${usedFallback?'YES':'NO'}\n\nHazards:\n`;
    hazards.forEach((h,i)=> out += `${i+1}. ${h.name} | L=${h.L} S=${h.S} Risk=${h.risk}\n`);
    out += `\nRecommendations:\n${[...new Set(hazards.flatMap(h=>h.recs||[]))].map((r,i)=>`${i+1}. ${r}`).join('\n')}`;
    const blob = new Blob([out], {type:'text/plain'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `HSE_Risk_Assessment_${new Date().toISOString().slice(0,10)}.txt`; a.click(); URL.revokeObjectURL(url);
  }

  function resetApp(){ stopCamera(); hazards=[]; overall=0; imageData=null; usedFallback=false; els.fileInput.value=''; els.results.classList.add('hidden'); }

  function captureFromCamera(){
    if (!els.videoPreview.videoWidth || !els.videoPreview.videoHeight) {
      showWarning('No camera frame available yet. If this persists, stop camera and use Upload Image.');
      return;
    }
    const c=document.createElement('canvas');
    c.width=els.videoPreview.videoWidth;
    c.height=els.videoPreview.videoHeight;
    c.getContext('2d').drawImage(els.videoPreview,0,0);
    stopCamera();
    analyze(c.toDataURL('image/jpeg',0.9));
  }

  els.btnCamera.addEventListener('click', startCamera);
  els.btnUpload.addEventListener('click', openFilePicker);
  els.btnCapture.addEventListener('click', captureFromCamera);
  els.btnStop.addEventListener('click', stopCamera);
  els.btnExport.addEventListener('click', exportReport);
  els.btnReset.addEventListener('click', resetApp);
  els.fileInput.addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    if(!f.type.startsWith('image/')) { showWarning('Please upload a valid image file.'); e.target.value=''; return; }
    const reader = new FileReader();
    reader.onload = (ev) => analyze(ev.target.result);
    reader.onerror = () => showWarning('Failed to read selected image.');
    reader.readAsDataURL(f);
  });
  els.uploadArea.addEventListener('click', openFilePicker);
  els.uploadArea.addEventListener('keydown', (e) => { if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openFilePicker(); }});

  window.openFilePicker = openFilePicker;
  window.startCam = startCamera;
  window.stopCam = stopCamera;
  window.capture = captureFromCamera;
  window.analyze = analyze;
  window.exportReport = exportReport;
  window.resetApp = resetApp;

  initModel();
})();
</script>
</body>
</html>
