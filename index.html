<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisualRiskAssessor - HSE Risk Assessment</title>
    <script src="./web/vendor/tfjs-4.10.0.min.js"></script>
    <script src="./web/vendor/mobilenet-2.1.0.min.js"></script>
    <style>
        :root { --primary: #FF6D00; --primary-dark: #E65100; --secondary: #1565C0; --bg: #F5F5F5; --surface: #fff; --text: #212121; --text2: #616161; --low: #4CAF50; --med: #FFC107; --high: #F44336; --extreme: #B71C1C; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 8px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .card { background: var(--surface); border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        .card h2 { color: var(--secondary); margin-bottom: 20px; font-size: 1.4rem; }
        .diag-panel { margin: 18px 0 4px; padding: 14px; border-radius: 12px; background: #f7f9fc; border: 1px solid #d9e3f5; }
        .diag-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px solid #e8eef9; font-size: 0.95rem; }
        .diag-item:last-child { border-bottom: 0; }
        .diag-status { font-weight: 700; }
        .diag-ok { color: #2e7d32; }
        .diag-warn { color: #ef6c00; }
        .diag-error { color: #c62828; }
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 25px 0; }
        .btn { padding: 16px 32px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #0D47A1; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        .camera-sec { display: none; text-align: center; }
        .camera-sec.active { display: block; }
        #videoPreview { width: 100%; max-width: 600px; border-radius: 12px; background: #000; }
        .upload-area { border: 3px dashed var(--secondary); border-radius: 16px; padding: 50px; text-align: center; cursor: pointer; transition: 0.3s; background: #f8fbff; }
        .upload-area:hover { background: #e3f2fd; border-color: var(--primary); }
        .upload-icon { font-size: 4rem; }
        #fileInput { display: none; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .loading.active { display: flex; }
        .spinner { width: 70px; height: 70px; border: 5px solid rgba(255,255,255,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 25px; font-size: 1.3rem; }
        .results { display: none; }
        .results.active { display: block; }
        .photo-ref { text-align: center; margin-bottom: 25px; }
        .photo-ref img { max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .photo-label { display: inline-block; background: var(--secondary); color: white; padding: 8px 20px; border-radius: 20px; margin-top: 15px; font-weight: 600; }
        .overall-risk { text-align: center; margin: 25px 0; padding: 30px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: 16px; }
        .overall-score { font-size: 4rem; font-weight: 800; }
        .overall-level { font-size: 1.8rem; font-weight: 700; margin-top: 10px; }
        .hazard-item { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--med); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .hazard-item.risk-low { border-left-color: var(--low); }
        .hazard-item.risk-medium { border-left-color: var(--med); }
        .hazard-item.risk-high { border-left-color: var(--high); }
        .hazard-item.risk-extreme { border-left-color: var(--extreme); }
        .hazard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .hazard-name { font-size: 1.2rem; font-weight: 700; }
        .hazard-conf { background: var(--secondary); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; }
        .hazard-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .detail-item { text-align: center; }
        .detail-label { font-size: 0.75rem; color: var(--text2); text-transform: uppercase; }
        .detail-value { font-size: 1.2rem; font-weight: 700; }
        .matrix-sec { padding: 25px; background: linear-gradient(135deg, #f8f9fa, #fff); border-radius: 16px; margin: 25px 0; }
        .matrix-title { text-align: center; color: var(--secondary); margin-bottom: 20px; font-size: 1.4rem; }
        .risk-matrix { display: grid; grid-template-columns: 40px repeat(5, 1fr); gap: 3px; max-width: 480px; margin: 0 auto; }
        .matrix-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; border-radius: 6px; min-height: 50px; }
        .matrix-label { background: transparent; font-weight: 700; color: var(--text2); font-size: 0.65rem; }
        .matrix-header { background: var(--secondary); color: white; font-weight: 700; }
        .cell-low { background: var(--low); color: white; }
        .cell-medium { background: var(--med); color: #000; }
        .cell-high { background: var(--high); color: white; }
        .cell-extreme { background: var(--extreme); color: white; }
        .current-marker { border: 4px solid gold !important; box-shadow: 0 0 15px gold; }
        .methodology { background: #E3F2FD; padding: 20px; border-radius: 12px; margin: 20px 0; font-size: 0.95rem; color: #0D47A1; }
        .methodology h4 { color: var(--secondary); margin-bottom: 10px; }
        .rec-item { display: flex; gap: 15px; padding: 18px; background: #f8f9fa; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
        .rec-icon { font-size: 1.8rem; flex-shrink: 0; }
        .rec-content h4 { color: var(--text); margin-bottom: 5px; }
        .rec-content p { color: var(--text2); font-size: 0.95rem; }
        .actions { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-restart { background: #616161; color: white; }
        .hidden { display: none !important; }
        .instr { text-align: center; color: var(--text2); margin: 15px 0; font-size: 1.05rem; }
        @media (max-width: 768px) { .btn { width: 100%; justify-content: center; } .hazard-details { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <h1>üî¨ VisualRiskAssessor</h1>
        <p>HSE Risk Assessment - Identify Hazards, Assess Risks, Ensure Safety</p>
    </header>
    <main class="container">
        <section class="card" id="inputSec">
            <h2>üì∏ Capture Workplace Image</h2>
            <p class="instr">Take a photo or upload an image of a workplace area to analyze for potential health and safety hazards.</p>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startCam()">üì∑ Take Photo</button>
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">üñºÔ∏è Upload from Library</button>
                <button class="btn btn-outline hidden" onclick="stopCam()" id="stopBtn">‚èπÔ∏è Stop Camera</button>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFile(event)">
            <div class="camera-sec" id="camSec"><video id="videoPreview" autoplay playsinline muted webkit-playsinline style="width:100%;height:auto;max-height:70vh;object-fit:cover;border-radius:12px;background:#000;"></video><button class="btn btn-primary" style="margin:15px auto" onclick="capture()">üî¥ Capture</button></div>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()"><div class="upload-icon">üìÅ</div><div class="instr">Click to upload or drag image<br><small>JPEG, PNG, WEBP</small></div></div>
            <div class="diag-panel" id="diagPanel" role="status" aria-live="polite">
                <div class="diag-item"><span>Browser support</span><span class="diag-status diag-warn" id="diagBrowser">Checking‚Ä¶</span></div>
                <div class="diag-item"><span>Model status</span><span class="diag-status diag-warn" id="diagModel">Initializing‚Ä¶</span></div>
                <div class="diag-item"><span>Camera status</span><span class="diag-status diag-warn" id="diagCamera">Not requested</span></div>
            </div>
        </section>
        <div class="loading" id="loading"><div class="spinner"></div><div class="loading-text" id="loadText">Analyzing image...</div></div>
        <section class="results" id="results">
            <div class="card photo-ref"><img id="resultImg"><div class="photo-label">üì∏ Reference Image</div></div>
            <div class="overall-risk"><div>OVERALL RISK SCORE</div><div class="overall-score" id="overallScore">0</div><div class="overall-level" id="overallLevel">Assessing...</div></div>
            <div class="card"><h2>üö® Hazards Identified</h2><p class="instr">The following hazards were detected:</p><div id="hazardsList"></div></div>
            <div class="card"><h2>üìä Risk Assessment Matrix</h2><div class="matrix-sec"><div class="matrix-title">Likelihood √ó Severity = Risk</div><div class="risk-matrix" id="riskMatrix"></div></div><div class="methodology"><h4>üìñ HSE Methodology</h4><p><strong>Risk = Likelihood √ó Severity</strong></p><p>üü¢ Low (1-5) - Acceptable | üü° Medium (6-14) - Additional controls | üî¥ High (15-19) - Urgent action | ‚ö´ Extreme (20-25) - Immediate action</p></div></div>
            <div class="card"><h2>üõ°Ô∏è Safety Recommendations</h2><div id="recsList"></div></div>
            <div class="actions"><button class="btn btn-primary" onclick="exportReport()">üì• Download Full Report</button><button class="btn btn-restart" onclick="resetApp()">üîÑ New Assessment</button></div>
        </section>
    </main>
    <script>
    const ML_MODEL_CONFIG={
        localModelUrl:"./web/models/mobilenet/model.json",
        preferLocalModel:false
    };
    const hazardDB = {
        slip_floor:{name:"Floor Surface Hazard",kw:["floor","ground","tile","carpet"],L:4,S:3,recs:[{i:"üßπ",t:"Clean Floors",d:"Keep floors clean and free from debris"},{i:"‚ö†Ô∏è",t:"Warning Signs",d:"Use wet floor signs"},{i:"üëü",t:"Footwear",d:"Slip-resistant safety footwear"}]},
        slip_stairs:{name:"Stairway Hazard",kw:["stairs","staircase","step","ladder"],L:3,S:4,recs:[{i:"ü™ú",t:"Handrails",d:"Install secure handrails"},{i:"‚ö†Ô∏è",t:"Anti-slip",d:"Apply anti-slip strips"},{i:"üî¶",t:"Lighting",d:"Adequate stair lighting"}]},
        slip_water:{name:"Wet Surface Hazard",kw:["water","liquid","puddle","spill"],L:4,S:3,recs:[{i:"üßΩ",t:"Immediate Cleanup",d:"Clean spills immediately"},{i:"üõë",t:"Isolation",d:"Block off wet areas"},{i:"üíß",t:"Source",d:"Fix source of water"}]},
        elec_outlet:{name:"Electrical Outlet",kw:["outlet","socket","power"],L:2,S:5,recs:[{i:"üîå",t:"Inspect",d:"Regular outlet inspection"},{i:"üö´",t:"No Overload",d:"Don't overload outlets"},{i:"‚ö°",t:"GFCI",d:"Install GFCI protection"}]},
        elec_wire:{name:"Exposed Wiring",kw:["wire","cable","cord"],L:3,S:5,recs:[{i:"üîß",t:"Cover Wires",d:"Cover exposed wiring"},{i:"üõ°Ô∏è",t:"Conduit",d:"Use cable conduit"},{i:"‚ö°",t:"Power Off",d:"Turn off power before work"}]},
        fire_ext:{name:"Fire Equipment",kw:["extinguisher","fire alarm"],L:2,S:5,recs:[{i:"‚úÖ",t:"Accessible",d:"Keep extinguishers accessible"},{i:"üìÖ",t:"Inspect",d:"Monthly inspections"},{i:"üè∑Ô∏è",t:"Signage",d:"Clear emergency signage"}]},
        fire_flam:{name:"Flammable Materials",kw:["flammable","gasoline","chemical"],L:2,S:5,recs:[{i:"üè™",t:"Storage",d:"Approved safety cabinets"},{i:"üö≠",t:"No Smoking",d:"Strict no smoking policy"},{i:"üßØ",t:"Suppression",d:"Fire suppression nearby"}]},
        chem:{name:"Chemical Storage",kw:["bottle","container","drum","can"],L:2,S:4,recs:[{i:"üß™",t:"Labeling",d:"Clear chemical labeling"},{i:"üóÑÔ∏è",t:"Storage",d:"Approved chemical cabinets"},{i:"üò∑",t:"PPE",d:"Appropriate PPE available"}]},
        machine:{name:"Machinery Hazard",kw:["machine","motor","equipment","tool"],L:3,S:4,recs:[{i:"üõ°Ô∏è",t:"Guards",d:"Safety guards in place"},{i:"üîí",t:"Lockout",d:"Lockout/tagout procedures"},{i:"üë∑",t:"Training",d:"Operator certification"}]},
        ergo:{name:"Workstation Ergonomics",kw:["chair","desk","computer","keyboard"],L:4,S:2,recs:[{i:"ü™ë",t:"Ergonomic Chair",d:"Adjustable seating"},{i:"üñ•Ô∏è",t:"Monitor Position",d:"Eye level monitor"},{i:"‚è∞",t:"Breaks",d:"Regular break schedule"}]},
        ergo_lift:{name:"Manual Handling",kw:["box","heavy","lift"],L:4,S:3,recs:[{i:"üèãÔ∏è",t:"Lifting Aids",d:"Use mechanical aids"},{i:"üë•",t:"Team Lift",d:"Two-person for heavy loads"},{i:"üìê",t:"Technique",d:"Proper lifting training"}]},
        height:{name:"Working at Height",kw:["ladder","scaffold","building","construction"],L:2,S:5,recs:[{i:"ü¶∫",t:"Fall Protection",d:"Use fall protection"},{i:"üèóÔ∏è",t:"Scaffold",d:"Proper scaffold inspection"},{i:"‚úÖ",t:"Daily Checks",d:"Documented daily inspections"}]},
        general:{name:"General Workplace",kw:["office","room","indoor","workspace"],L:3,S:2,recs:[{i:"üßπ",t:"Housekeeping",d:"Clean organized areas"},{i:"ü™ú",t:"Clear Walkways",d:"No obstructions"},{i:"üî¶",t:"Emergency Lighting",d:"Functional lighting"}]}
    };
    let model=null,video=null,imgData=null,hazards=[],overallScore=0;
    function setDiag(id,message,level){
        const el=document.getElementById(id);
        if(!el){return;}
        el.textContent=message;
        el.className=`diag-status ${level||"diag-warn"}`;
    }
    function detectBrowserSupport(){
        const supportsMedia=Boolean(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);
        const supportsCanvas=Boolean(window.HTMLCanvasElement&&window.FileReader);
        if(supportsMedia&&supportsCanvas){
            setDiag('diagBrowser','Supported','diag-ok');
            return true;
        }
        setDiag('diagBrowser','Unsupported browser','diag-error');
        return false;
    }
    async function init(){
        if(!detectBrowserSupport()){
            setDiag('diagModel','Unavailable (browser unsupported)','diag-error');
            return;
        }
        const useLocal=ML_MODEL_CONFIG.preferLocalModel||window.location.search.includes('localModel=1');
        const options=useLocal?{modelUrl:ML_MODEL_CONFIG.localModelUrl}:undefined;
        try{
            model=await mobilenet.load(options);
            setDiag('diagModel',useLocal?'Loaded local model':'Loaded CDN model','diag-ok');
            console.log('Model loaded');
        }catch(e){
            setDiag('diagModel','Model load failed','diag-error');
            console.error('Model failed', e);
        }
    }
    function showLoad(message){
        const loading=document.getElementById('loading');
        const loadText=document.getElementById('loadText');
        if(message){
            loadText.textContent=message;
        }
        loading.classList.add('active');
    }
    function hideLoad(){document.getElementById('loading').classList.remove('active');}
    function ensureSecureContext(){
        const isLocalhost=['localhost','127.0.0.1'].includes(window.location.hostname);
        if(window.location.protocol!=='https:'&&!isLocalhost){
            const httpsUrl=`https://${window.location.host}${window.location.pathname}${window.location.search}${window.location.hash}`;
            if(window.location.hostname.endsWith('github.io')){
                window.location.replace(httpsUrl);
                return;
            }
            showHttpsBanner(httpsUrl);
        }
    }
    function showHttpsBanner(httpsUrl){
        if(document.getElementById('httpsNotice')){return;}
        const banner=document.createElement('div');
        banner.id='httpsNotice';
        banner.style.cssText='background:#0D47A1;color:white;padding:12px 20px;text-align:center;font-weight:600;';
        banner.innerHTML=`Secure HTTPS is required for camera access. <a href="${httpsUrl}" style="color:#FFD54F;text-decoration:underline;">Switch to HTTPS</a>`;
        document.body.insertBefore(banner, document.body.firstChild);
    }
    async function startCam(){
        if(!detectBrowserSupport()){
            alert("Camera is not supported in this browser. Please upload an image instead.");
            return;
        }
        setDiag('diagCamera','Requesting camera permission‚Ä¶','diag-warn');
        let constraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: "environment"
            }
        };

        try {
            // Try with rear camera first
            let stream = await navigator.mediaDevices.getUserMedia(constraints);

            // If rear camera fails, try front camera
            if (!stream.getVideoTracks().length) {
                stream.getTracks().forEach(track => track.stop());
                constraints.video.facingMode = "user";
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            }

            const videoEl = document.getElementById("videoPreview");
            videoEl.srcObject = stream;
            video = stream;
            
            // Wait for video to load
            videoEl.onloadedmetadata = () => {
                videoEl.play();
                document.getElementById("camSec").classList.add("active");
                document.getElementById("uploadArea").classList.add("hidden");
                document.getElementById("stopBtn").classList.remove("hidden");
                setDiag('diagCamera','Camera ready','diag-ok');
            };
            
        } catch (error) {
            console.error("Camera error:", error);
            
            let errorMessage = "Unable to access camera. ";
            
            if (error.name === "NotAllowedError") {
                setDiag('diagCamera','Camera denied','diag-error');
                errorMessage += "Please allow camera permission and try again.";
            } else if (error.name === "NotFoundError") {
                setDiag('diagCamera','No camera available','diag-error');
                errorMessage += "No camera found on this device.";
            } else if (error.name === "NotReadableError") {
                setDiag('diagCamera','Camera busy','diag-error');
                errorMessage += "Camera is being used by another application.";
            } else {
                setDiag('diagCamera','Camera failed','diag-error');
                errorMessage += "Please use the upload feature instead.";
            }
            
            // Show more detailed error and suggest upload
            const shouldUpload = confirm(errorMessage + "\n\nWould you like to upload an image instead?");
            if (shouldUpload) {
                document.getElementById("fileInput").click();
            }
        }
    }
    function stopCam(){if(video){video.getTracks().forEach(t=>t.stop());video=null;}document.getElementById('camSec').classList.remove('active');document.getElementById('uploadArea').classList.remove('hidden');document.getElementById('stopBtn').classList.add('hidden');}
    function resetApp(){
        stopCam();
        hazards=[];
        overallScore=0;
        imgData=null;
        document.getElementById('fileInput').value='';
        document.getElementById('hazardsList').innerHTML='';
        document.getElementById('recsList').innerHTML='';
        document.getElementById('riskMatrix').innerHTML='';
        document.getElementById('overallScore').textContent='0';
        document.getElementById('overallLevel').textContent='Assessing...';
        document.getElementById('overallLevel').style.background='';
        document.getElementById('resultImg').removeAttribute('src');
        document.getElementById('results').classList.remove('active');
        document.getElementById('inputSec').classList.remove('hidden');
        window.scrollTo({top:0,behavior:'smooth'});
    }
    function capture(){const v=document.getElementById('videoPreview'),c=document.createElement('canvas');c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);imgData=c.toDataURL('image/jpeg',0.9);stopCam();analyze(imgData);}
    function handleFile(e){
        const f=e.target.files[0];
        if(!f)return;
        if(!f.type.startsWith('image/')){
            alert('Please upload a valid image file.');
            e.target.value='';
            return;
        }
        if(f.size>10*1024*1024){
            alert('Please upload an image under 10MB.');
            e.target.value='';
            return;
        }
        const r=new FileReader();
        r.onload=function(e){imgData=e.target.result;analyze(imgData);};
        r.onerror=function(){alert('Unable to read the selected file.');};
        r.readAsDataURL(f);
    }
    async function analyze(img){showLoad();hazards=[];try{if(model&&img){const i=new Image();i.onload=async()=>{try{const p=await model.classify(i);mapHazards(p);calcOverall();display();}catch(e){fallback();}hideLoad();};i.onerror=()=>{fallback();hideLoad();};i.src=img;}else{setTimeout(()=>{fallback();hideLoad();},1500);}}catch(e){fallback();hideLoad();}}
    function mapHazards(preds){const found=new Set();preds.forEach(p=>{const l=p.className.toLowerCase();Object.entries(hazardDB).forEach(([k,h])=>{h.kw.forEach(kw=>{if(l.includes(kw)&&!found.has(k)){found.add(k);hazards.push({id:k,...h,conf:p.probability,risk:h.L*h.S});}});});});if(hazards.length===0)hazards.push({...hazardDB.general,conf:0.8,risk:6});}
    function fallback(){hazards=[{...hazardDB.general,conf:0.8,risk:6},{...hazardDB.slip_floor,conf:0.6,risk:12}];}
    function calcOverall(){overallScore=hazards.length?Math.max(...hazards.map(h=>h.risk)):0;}
    function getRisk(s){if(s<=5)return{l:'Low',c:'#4CAF50'};if(s<=14)return{l:'Medium',c:'#FFC107'};if(s<=19)return{l:'High',c:'#F44336'};return{l:'Extreme',c:'#B71C1C'};}
    function display(){document.getElementById('resultImg').src=imgData;const r=getRisk(overallScore);document.getElementById('overallScore').textContent=overallScore;document.getElementById('overallLevel').textContent=r.l+' Risk';document.getElementById('overallLevel').style.background=r.c;const L=['Rare','Unlikely','Possible','Likely','Certain'],S=['','Insignificant','Minor','Moderate','Major','Catastrophic'];document.getElementById('hazardsList').innerHTML=hazards.map(h=>{const r=getRisk(h.risk);return`<div class="hazard-item risk-${r.l.toLowerCase()}"><div class="hazard-header"><span class="hazard-name">${h.name}</span><span class="hazard-conf">${Math.round(h.conf*100)}%</span></div><div class="hazard-details"><div class="detail-item"><div class="detail-label">Likelihood</div><div class="detail-value">${h.L}-${L[h.L-1]}</div></div><div class="detail-item"><div class="detail-label">Severity</div><div class="detail-value">${h.S}-${S[h.S]}</div></div><div class="detail-item"><div class="detail-label">Risk</div><div class="detail-value" style="color:${r.c}">${h.risk}</div></div><div class="detail-item"><div class="detail-label">Level</div><div class="detail-value" style="color:${r.c}">${r.l}</div></div></div></div>`;}).join('');drawMatrix();dispRecs();document.getElementById('results').classList.add('active');document.getElementById('inputSec').classList.add('hidden');window.scrollTo({top:0,behavior:'smooth'});}
    function drawMatrix(){const m=document.getElementById('riskMatrix');let html='<div class="matrix-cell"></div>';['1','2','3','4','5'].forEach(s=>html+=`<div class="matrix-cell matrix-header">S:${s}</div>`);for(let l=0;l<5;l++){html+=`<div class="matrix-cell matrix-header">L:${l+1}</div>`;for(let s=0;s<5;s++){const sc=(l+1)*(s+1),cls=sc>=20?'cell-extreme':sc>=15?'cell-high':sc>=6?'cell-medium':'cell-low',mk=hazards.some(h=>h.risk===sc)?'current-marker':'';html+=`<div class="matrix-cell ${cls} ${mk}">${sc}</div>`;}}m.innerHTML=html;}
    function dispRecs(){const recs=[];hazards.forEach(h=>{if(h.recs)h.recs.forEach(r=>{if(!recs.find(x=>x.t===r.t))recs.push(r);});});recs.push({i:"üìã",t:"Regular Audits",d:"Conduct routine safety inspections"},{i:"üì¢",t:"Report Hazards",d:"Encourage immediate hazard reporting"});document.getElementById('recsList').innerHTML=recs.map(r=>`<div class="rec-item"><div class="rec-icon">${r.i}</div><div class="rec-content"><h4>${r.t}</h4><p>${r.d}</p></div></div>`).join('');}
    function exportReport(){
        const L=['Rare','Unlikely','Possible','Likely','Certain'];
        const S=[ '','Insignificant','Minor','Moderate','Major','Catastrophic'];
        const now=new Date();
        const r=getRisk(overallScore);
        let rep=`

                    OCCUPATIONAL HEALTH & SAFETY RISK ASSESSMENT
                              ISO 45001:2018 COMPLIANT


DOCUMENT REFERENCE:    HSE-RA-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${(now.getDate()).toString().padStart(2,'0')}-${Date.now().toString().slice(-6)}
ASSESSMENT DATE:     ${now.toLocaleDateString()}
ASSESSMENT TIME:     ${now.toLocaleTimeString()}
METHODOLOGY:         ISO 45001:2018 / ISO 31000:2018


                          ASSESSMENT SUMMARY


OVERALL RISK RATING:     ${r.l.toUpperCase()}
RISK SCORE:             ${overallScore} / 25
HAZARDS IDENTIFIED:     ${hazards.length}


RISK MATRIX

        Severity  1    2    3    4    5
Likelihood
    1         1    2    3    4    5   Rare
    2         2    4    6    8   10   Unlikely
    3         3    6    9   12   15   Possible
    4         4    8   12   16   20   Likely
    5         5   10   15   20   25   Certain


                          HAZARDS IDENTIFIED

`;
        hazards.forEach((h,i)=>{
            const risk=getRisk(h.risk);
            rep+=`
--------------------------------------------------------------------------------
HAZARD #${i+1}: ${h.name.toUpperCase()}
--------------------------------------------------------------------------------
CATEGORY:              ${h.category || 'Workplace Hazard'}
CONFIDENCE:           ${Math.round(h.conf*100)}%

RISK ANALYSIS:
  Likelihood:       ${h.L} - ${L[h.L-1]}
  Severity:         ${h.S} - ${S[h.S]}
  Risk Score:       ${h.risk}
  Risk Level:       ${risk.l.toUpperCase()}

CONTROLS REQUIRED:
`;
            if(h.recs){h.recs.forEach((rec,idx)=>{rep+=`  ${idx+1}. ${rec.t} - ${rec.d}`;});}
            rep+="\\n";
        });
        rep+=`


                          RISK CLASSIFICATION


 EXTREME (20-25): Immediate action - STOP WORK until controlled


                          RECOMMENDATIONS

`;
        const uniqueRecs=[];
        hazards.forEach(h=>{if(h.recs)h.recs.forEach(r=>{if(!uniqueRecs.find(x=>x.t===r.t))uniqueRecs.push(r);});});
        uniqueRecs.forEach((rec,i)=>{const priority=i<3?'HIGH':i<6?'MEDIUM':'LOW';rep+=`
${i+1}. [${priority}] ${rec.t}
   Action: ${rec.d}`;});
        rep+=`


                          ISO 45001:2018 COMPLIANCE


This assessment complies with:
 ISO 45001:2018 - Occupational health and safety management
 ISO 31000:2018 - Risk management
 ISO 45002:2021 - OHS management in practice

KEY CLAUSES: 6.1.2 Hazard ID, 6.1.2.2 Risk Assessment, 8.1.1 Planning


                          SIGNATURES


Assessor: __________________  Date: __________
Manager:  __________________  Date: __________
Next Review: ${new Date(now.getTime()+90*24*60*60*1000).toLocaleDateString()} (90 days)


                    Generated: ${now.toLocaleString()}
              VisualRiskAssessor - ISO 45001 Compliant
`;
        const b=new Blob([rep],{type:'text/plain'});
        const u=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=u;
        a.download=`HSE_Risk_Assessment_${now.toISOString().slice(0,10)}_ISO45001.txt`;
        a.click();
        URL.revokeObjectURL(u);
    }
    window.addEventListener('load',()=>{ensureSecureContext();init();});
